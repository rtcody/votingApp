<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votify</title>

    <style>
        [data-tab-content] {
            display: none;
        }

        .active[data-tab-content] {
            display: block;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            list-style-type: none;
            margin: 0;
            margin-top: 100px;
            padding: 0;
            border-top: 1px solid black;
            border-bottom: 1px solid black;
            border-width: 15px;
        }

        body {
            background: linear-gradient(to right, rgb(199, 210, 230), #cae0f6);
            margin: 0;
            padding: 0;
        }

        .tab {
            cursor: pointer;
            padding: 10px;
        }

        .tab.active {
            background-color: rgb(172, 191, 209);
        }

        .votify {
            position: absolute;
            top: 0px;
            left: 10px;
            font-family: 'Segoe UI', Tahoma, Verdana, sans-serif;
            font-size: 20px;
            font-variant-caps: all-petite-caps;
        }

        #create {
            position: absolute;
            top: 210px;
            left: 400px;
            padding: 15px 200px;
            font-size: 15px;
            background-color: rgb(92, 108, 148);
            color: white;
            border: none;
            border-radius: 70px;
            cursor: pointer;
        }

        .createButton {
            color: white;
            text-align: center;
            padding: 10px 30px;
            font-size: 15px;
            background-color: black;
            border-radius: 5px;
            cursor: pointer;
        }

        .createButton:hover {
            background-color: rgb(50, 48, 57);
        }

        .poll-box {
            background-color: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .poll-question {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .vote-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .vote-form {
            margin-top: 15px;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }

        .vote-form input {
            margin-bottom: 10px;
        }

        .agree, .disagree {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: all 0.2s ease;
        }

        .agree {
            background-color: #4CAF50; /* Green */
        }

        .disagree {
            background-color: #F44336; /* Red */
        }

        .agree:hover {
            background-color: #3e8e41; /* Darker green */
        }

        .disagree:hover {
            background-color: #d32f2f; /* Darker red */
        }

        .vote-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
        }

        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }

        .error {
            background-color: #f2dede;
            color: #a94442;
        }

        #pollsList {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .tabsContainer {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        form {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }

        input[type="text"], input[type="password"], input[type="datetime-local"] {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <ul class="tabs">
        <li data-tab-target="#home" class="active tab">Home</li>
        <li data-tab-target="#vote" class="tab">Vote</li>
        <li data-tab-target="#create" class="tab">Create Poll</li>
    </ul>

    <div class="tabsContainer">

        <div id="home" data-tab-content class="active">
            <h1>Welcome to Votify!</h1>
            <p>- Navigate to "Vote" to vote on polls</p>
            <p>- Navigate to "Create Poll" to create polls</p>
        </div>

        <div id="vote" data-tab-content>
            <h1>Time to Vote!</h1>
            <p>Here are the available polls:</p>
            <div id="pollsList"></div>
        </div>

        <div id="create" data-tab-content>
            <h1>Create a poll</h1>
            <form id="createPollForm">
                <label for="questionInput">Poll Question:</label><br>
                <input type="text" id="questionInput" name="question" required><br><br>

                <label for="expiresInput">Expires At:</label><br>
                <input type="datetime-local" id="expiresInput" name="expires" required><br><br>

                <label for="usernameInput">Username: </label><br>
                <input type="text" id="usernameInput" name="username" required><br><br>

                <label for="passwordInput">Password: </label><br>
                <input type="password" id="passwordInput" name="password" required><br><br>

                <button class="createButton" type="submit">Create Poll</button>
            </form>
            <p id="createPollMessage" style="color: rgb(0, 0, 0);"></p>
        </div>
    </div>

    <div class="votify">
        <h1>Votify</h1>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('[data-tab-target]');
            const tabContents = document.querySelectorAll('[data-tab-content]');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = document.querySelector(tab.dataset.tabTarget);
                    
                    tabContents.forEach(tabContent => {
                        tabContent.classList.remove('active');
                    });
                    
                    tabs.forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    tab.classList.add('active');
                    target.classList.add('active');

                    if (tab.dataset.tabTarget === "#vote") {
                        loadPolls();
                    }
                });
            });

            document.getElementById('createPollForm').addEventListener('submit', createPoll);
            
            // Load polls initially if we're on the vote tab
            if (document.querySelector('[data-tab-target="#vote"]').classList.contains('active')) {
                loadPolls();
            }
        });

        function loadPolls() {
            const pollsList = document.getElementById('pollsList');
            pollsList.innerHTML = '<p>Loading polls...</p>';
            
            fetch('http://127.0.0.1:5000/api/v1/polls')
                .then(res => {
                    if (!res.ok) throw new Error('Failed to fetch polls');
                    return res.json();
                })
                .then(data => {
                    pollsList.innerHTML = '';

                    if (data.length === 0) {
                        pollsList.innerHTML = '<p>No polls available right now.</p>';
                        return;
                    }

                    // Based on the backend, data is an array of objects with 'question' property
                    data.forEach((poll, index) => {
                        const pollDiv = document.createElement('div');
                        pollDiv.className = 'poll-box';
                        // Store poll ID (if available) or use index as a fallback
                        const pollId = poll.poll_id || index + 1;
                        pollDiv.id = `poll-${pollId}`;

                        const question = document.createElement('div');
                        question.className = 'poll-question';
                        question.textContent = poll.question;

                        const voteForm = document.createElement('div');
                        voteForm.className = 'vote-form';
                        voteForm.innerHTML = `
                            <h3>Cast your vote:</h3>
                            <input type="text" placeholder="Username" class="username-input" required>
                            <input type="password" placeholder="Password" class="password-input" required>
                            <div class="vote-buttons">
                                <button class="agree" data-vote="agree">üëç Agree</button>
                                <button class="disagree" data-vote="disagree">üëé Disagree</button>
                            </div>
                            <div class="vote-status"></div>
                        `;

                        // Add event listeners for vote buttons
                        const agreeBtn = voteForm.querySelector('.agree');
                        const disagreeBtn = voteForm.querySelector('.disagree');

                        agreeBtn.addEventListener('click', () => {
                            submitVote(pollId, 'agree', voteForm);
                        });

                        disagreeBtn.addEventListener('click', () => {
                            submitVote(pollId, 'disagree', voteForm);
                        });

                        pollDiv.appendChild(question);
                        pollDiv.appendChild(voteForm);
                        
                        pollsList.appendChild(pollDiv);
                    });
                })
                .catch(error => {
                    pollsList.innerHTML = `<p>Error loading polls: ${error.message}</p>`;
                });
        }

        function submitVote(pollId, voteType, formElement) {
            const username = formElement.querySelector('.username-input').value;
            const password = formElement.querySelector('.password-input').value;
            const statusElement = formElement.querySelector('.vote-status');
            
            if (!username || !password) {
                statusElement.textContent = 'Please enter your username and password';
                statusElement.className = 'vote-status error';
                return;
            }
            
            // Disable buttons while submitting
            const buttons = formElement.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            
            statusElement.textContent = 'Submitting vote...';
            statusElement.className = 'vote-status';
            
            const voteData = {
                username: username,
                password: password,
                poll_id: pollId,
                vote: voteType
            };
            
            fetch('http://127.0.0.1:5000/api/v1/record_vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(voteData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Vote failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                statusElement.textContent = data.message || 'Vote recorded successfully!';
                statusElement.className = 'vote-status success';
                
                // Update form to show vote has been cast
                formElement.querySelector('.username-input').disabled = true;
                formElement.querySelector('.password-input').disabled = true;
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = 0.5;
                });
                
                if (voteType === 'agree') {
                    formElement.querySelector('.agree').style.opacity = 1;
                } else {
                    formElement.querySelector('.disagree').style.opacity = 1;
                }
            })
            .catch(error => {
                statusElement.textContent = error.message;
                statusElement.className = 'vote-status error';
                // Re-enable buttons on error
                buttons.forEach(btn => btn.disabled = false);
            });
        }

        function createPoll(event) {
            event.preventDefault();

            const questionInput = document.getElementById('questionInput').value;
            const expiresInput = document.getElementById('expiresInput').value;
            const usernameInput = document.getElementById('usernameInput').value;
            const passwordInput = document.getElementById('passwordInput').value;
            const message = document.getElementById('createPollMessage');

            if (!questionInput || !expiresInput || !usernameInput || !passwordInput) {
                message.style.color = 'red';
                message.textContent = 'All fields are required!';
                return;
            }

            const createButton = document.querySelector('.createButton');
            createButton.disabled = true;
            createButton.textContent = 'Creating...';

            const pollData = {
                question: questionInput,
                expires_at: expiresInput,
                username: usernameInput,
                password: passwordInput
            };

            fetch('http://127.0.0.1:5000/api/v1/create_poll', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(pollData)
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(data => {
                        throw new Error(data.message || 'Failed to create poll');
                    });
                }
                return res.json();
            })
            .then(data => {
                message.style.color = 'green';
                message.textContent = data.message || 'Poll created successfully!';
                document.getElementById('createPollForm').reset();
                setTimeout(() => {
                    document.querySelector('[data-tab-target="#vote"]').click();
                }, 1000);
            })
            .catch(err => {
                message.style.color = 'red';
                message.textContent = err.message;
            })
            .finally(() => {
                createButton.disabled = false;
                createButton.textContent = 'Create Poll';
            });
        }
    </script>
</body>
</html>